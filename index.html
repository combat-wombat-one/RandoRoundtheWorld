<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Enhanced VR with Interactive Map</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: #000;
    }
    
    #startButton {
      position: absolute; 
      top: 50%; 
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px; 
      font-size: 18px;
      background: #2196F3; 
      color: #fff; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer;
      z-index: 999;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    #vrButton {
      position: absolute;
      top: 60%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 15px 30px;
      background: #FF9800;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      z-index: 1000;
      cursor: pointer;
      display: none;
    }
    
    #loading {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
    }
    
    #error {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
      max-width: 80%;
      text-align: center;
    }
    
    #mapContainer {
      position: fixed;
      top: -10000px;
      left: -10000px;
      width: 512px;
      height: 320px;
      background: white;
    }
    
    .info-panel {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-align: center;
      max-width: 80%;
    }
  </style>
</head>
<body>

<button id="startButton">Start Experience</button>
<button id="vrButton">Enter VR</button>
<div id="loading">Loading assets, please wait...</div>
<div id="error"></div>

<!-- Offscreen Leaflet map -->
<div id="mapContainer"></div>

<a-scene id="scene" embedded vr-mode-ui="enabled:true" visible="false" loading-screen="dotsColor: #0080e5; backgroundColor: #000000" webxr="optionalFeatures: local-floor; requiredFeatures: local-floor;">
  <a-assets id="assets">
    <!-- Fallback image in case loading fails -->
    <img id="fallback" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z/C/HgAGgwJ/lK3Q6wAAAABJRU5ErkJggg==" crossorigin="anonymous">
  </a-assets>
  
  <a-sky id="sky" color="#000000"></a-sky>
  
  <a-entity position="0 1.6 0">
    <a-camera>
      <a-cursor fuse="true" fuse-timeout="800"
                raycaster="objects:.clickable"
                material="color: cyan"
                geometry="radiusInner:0.005;radiusOuter:0.015">
      </a-cursor>
    </a-camera>
  </a-entity>
  
  <!-- Navigation UI -->
  <a-plane id="nextBtn" class="clickable" position="0.6 1 -2" width="0.8" height="0.3" color="#4CAF50">
    <a-text value="Next" align="center" color="white" position="0 0 0.01" width="5"></a-text>
  </a-plane>
  
  <a-plane id="prevBtn" class="clickable" position="-0.6 1 -2" width="0.8" height="0.3" color="#F44336">
    <a-text value="Previous" align="center" color="white" position="0 0 0.01" width="5"></a-text>
  </a-plane>
  
  <!-- Map Panel -->
  <a-plane id="mapPanel" position="-2 1.5 -1.5" width="1.6" height="1" color="#fff" material="shader: flat;">
    <a-text id="locationText" value="Loading..." align="center" position="0 -0.6 0.01" color="black" width="2"></a-text>
  </a-plane>
  
  <!-- Info Panel -->
  <a-entity position="0 0.5 -2">
    <a-text id="infoText" value="" align="center" color="white" width="3"></a-text>
  </a-entity>
  
  <!-- Fallback for non-VR -->
  <a-entity id="nonVrMessage" position="0 1.6 -3" visible="false">
    <a-text value="VR not available\nUse mouse to look around\nClick buttons to navigate" 
           align="center" color="white" width="3"></a-text>
  </a-entity>
</a-scene>

<div id="nonVrFallback" class="info-panel" style="display: none;">
  VR mode not available. Using desktop mode instead.
</div>

<script>
// DOM elements
const startButton = document.getElementById('startButton');
const vrButton = document.getElementById('vrButton');
const loadingIndicator = document.getElementById('loading');
const errorDisplay = document.getElementById('error');
const scene = document.getElementById('scene');
const assets = document.getElementById('assets');
const sky = document.getElementById('sky');
const nextBtn = document.getElementById('nextBtn');
const prevBtn = document.getElementById('prevBtn');
const mapPanel = document.getElementById('mapPanel');
const locationText = document.getElementById('locationText');
const infoText = document.getElementById('infoText');
const nonVrMessage = document.getElementById('nonVrMessage');
const nonVrFallback = document.getElementById('nonVrFallback');
const mapContainer = document.getElementById('mapContainer');

// App state
let data = [];
let currentIdx = 0;
let leafletMap;
let isVRAvailable = false;

// Check VR capabilities
function checkVRSupport() {
  return new Promise((resolve) => {
    if (navigator.xr) {
      navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
        isVRAvailable = supported;
        if (!supported) {
          nonVrMessage.setAttribute('visible', 'true');
          nonVrFallback.style.display = 'block';
        }
        resolve(supported);
      }).catch(() => {
        isVRAvailable = false;
        nonVrMessage.setAttribute('visible', 'true');
        nonVrFallback.style.display = 'block';
        resolve(false);
      });
    } else {
      isVRAvailable = false;
      nonVrMessage.setAttribute('visible', 'true');
      nonVrFallback.style.display = 'block';
      resolve(false);
    }
  });
}

// Show loading state
function showLoading(message) {
  loadingIndicator.textContent = message;
  loadingIndicator.style.display = 'block';
}

// Hide loading
function hideLoading() {
  loadingIndicator.style.display = 'none';
}

// Show error
function showError(message) {
  errorDisplay.textContent = message;
  errorDisplay.style.display = 'block';
  setTimeout(() => {
    errorDisplay.style.display = 'none';
  }, 5000);
}

// Load CSV data
function loadCSV() {
  showLoading('Loading location data...');
  
  return new Promise((resolve, reject) => {
    Papa.parse('locations.csv', {
      download: true,
      header: true,
      complete(r) {
        hideLoading();
        console.log('CSV data loaded:', r.data);
        
        data = r.data.filter(row => row.filename && row.latitude && row.longitude);
        
        if (data.length === 0) {
          const error = 'No valid data found in CSV. Ensure it has filename, latitude, and longitude columns.';
          showError(error);
          reject(error);
          return;
        }
        
        resolve(data);
      },
      error(err) {
        const error = `Failed to load CSV: ${err.message}`;
        showError(error);
        reject(error);
      }
    });
  });
}

// Preload images
function preloadImages() {
  showLoading('Preloading images...');
  
  let loadedCount = 0;
  const totalImages = data.length;
  
  return new Promise((resolve) => {
    data.forEach((row, i) => {
      const img = new Image();
      img.id = `img-${i}`;
      img.crossOrigin = 'anonymous';
      img.src = `Images/${row.filename.trim()}`;
      
      img.onload = () => {
        loadedCount++;
        console.log(`Loaded image ${i+1}/${totalImages}: ${img.src}`);
        
        // Add to assets if not already present
        if (!assets.querySelector(`#img-${i}`)) {
          assets.appendChild(img);
        }
        
        // Update loading message
        showLoading(`Loading images... (${loadedCount}/${totalImages})`);
        
        // If first image, display it
        if (i === 0) {
          setCurrentImage(0);
        }
        
        // Resolve when all images are loaded
        if (loadedCount === totalImages) {
          hideLoading();
          resolve();
        }
      };
      
      img.onerror = () => {
        console.error(`Failed to load image: ${row.filename}`);
        showError(`Failed to load image: ${row.filename}`);
        
        // Use fallback image
        row.failedToLoad = true;
        loadedCount++;
        
        if (loadedCount === totalImages) {
          hideLoading();
          resolve();
        }
      };
    });
  });
}

// Initialize Leaflet map
function initMap() {
  leafletMap = L.map(mapContainer, {
    center: [0, 0],
    zoom: 2,
    zoomControl: true,
    attributionControl: false,
    dragging: true,
    scrollWheelZoom: true,
    doubleClickZoom: true,
    boxZoom: true,
    keyboard: true,
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(leafletMap);

  // Update map texture on interaction
  leafletMap.on('moveend zoomend', updateMapTexture);
  
  // Initial update
  updateMapTexture();
}

// Update map texture
function updateMapTexture() {
  html2canvas(mapContainer, {
    backgroundColor: null,
    scale: 1,
    logging: false,
    useCORS: true
  }).then(canvas => {
    const texture = new THREE.CanvasTexture(canvas);
    texture.minFilter = THREE.LinearFilter;
    texture.magFilter = THREE.LinearFilter;
    
    const mesh = mapPanel.getObject3D('mesh');
    if (mesh) {
      mesh.material.map = texture;
      mesh.material.needsUpdate = true;
    }
  }).catch(err => {
    console.error('Failed to update map texture:', err);
  });
}

// Set current image
function setCurrentImage(index) {
  // Validate index
  if (index < 0) index = data.length - 1;
  if (index >= data.length) index = 0;
  
  currentIdx = index;
  const location = data[currentIdx];
  
  console.log(`Displaying image ${currentIdx}: ${location.filename}`);
  
  // Set sky image (use fallback if image failed to load)
  const imgId = location.failedToLoad ? '#fallback' : `#img-${currentIdx}`;
  sky.setAttribute('src', imgId);
  sky.setAttribute('color', '#fff');
  
  // Update map view
  if (leafletMap) {
    const lat = parseFloat(location.latitude);
    const lon = parseFloat(location.longitude);
    
    if (!isNaN(lat) && !isNaN(lon)) {
      leafletMap.setView([lat, lon], 12);
      
      // Add marker
      leafletMap.eachLayer(layer => {
        if (layer instanceof L.Marker) {
          leafletMap.removeLayer(layer);
        }
      });
      L.marker([lat, lon]).addTo(leafletMap);
    }
  }
  
  // Update location text
  if (locationText) {
    locationText.setAttribute('value', 
      `${location.filename}\nLat: ${location.latitude}, Lon: ${location.longitude}`);
  }
  
  // Update info text
  if (infoText) {
    infoText.setAttribute('value', 
      `Location ${currentIdx + 1} of ${data.length}\n${location.filename}`);
  }
}

// Next image
function nextImage() {
  setCurrentImage(currentIdx + 1);
}

// Previous image
function prevImage() {
  setCurrentImage(currentIdx - 1);
}

// Initialize the experience
async function initExperience() {
  try {
    // Check VR support
    await checkVRSupport();
    
    // Load data
    await loadCSV();
    
    // Preload images
    await preloadImages();
    
    // Initialize map
    initMap();
    
    // Show scene
    scene.setAttribute('visible', 'true');
    startButton.style.display = 'none';
    
    // Show VR button if supported
    if (isVRAvailable) {
      vrButton.style.display = 'block';
    }
    
    // Set up event listeners
    nextBtn.addEventListener('click', nextImage);
    prevBtn.addEventListener('click', prevImage);
    
    // VR button handler
    vrButton.addEventListener('click', () => {
      scene.enterVR().catch(err => {
        console.error('Failed to enter VR:', err);
        showError('Failed to enter VR. Ensure your headset is connected and WebXR is supported.');
      });
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight') nextImage();
      if (e.key === 'ArrowLeft') prevImage();
    });
    
    console.log('Experience initialized successfully');
    
  } catch (error) {
    console.error('Initialization error:', error);
    showError(`Failed to initialize: ${error.message}`);
    startButton.style.display = 'block';
  }
}

// Start button handler
startButton.addEventListener('click', initExperience);

// Sample data fallback (for testing without CSV)
if (window.location.href.includes('localhost') || window.location.href.includes('127.0.0.1')) {
  console.log('Localhost detected - adding test data fallback');
  
  // Mock data structure if CSV fails to load
  window.fallbackData = [
    {
      filename: 'pano1.jpg',
      latitude: '40.7128',
      longitude: '-74.0060',
      name: 'New York City'
    },
    {
      filename: 'pano2.jpg',
      latitude: '51.5074',
      longitude: '-0.1278',
      name: 'London'
    }
  ];
  
  // If no CSV loaded after 3 seconds, use fallback
  setTimeout(() => {
    if (data.length === 0 && window.fallbackData) {
      console.log('Using fallback data');
      data = window.fallbackData;
      preloadImages();
      initMap();
    }
  }, 3000);
}
</script>
</body>
</html>
