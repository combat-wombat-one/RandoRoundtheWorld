<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VR GeoGuessr - Fixed Version</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; background: #000; }
    #startButton { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px 40px; font-size: 18px; background: #2196F3; color: #fff; border: none; border-radius: 5px; cursor: pointer; z-index: 999; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    #mapContainer { position: fixed; top: -10000px; left: -10000px; width: 1024px; height: 640px; background: white; }
    /* The 2D timer is no longer needed, we use the one in VR */
  </style>
</head>
<body>

<button id="startButton">Start Game</button>
<div id="mapContainer"></div>

<a-scene id="scene" 
         vr-mode-ui="enabled: true; refSpaceType: local-floor"
         renderer="antialias: true; logarithmicDepthBuffer: true"
         visible="false">
         
  <a-assets id="assets-container">
    <img id="fallback" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z/C/HgAGgwJ/lK3Q6wAAAABJRU5ErkJggg==" crossorigin="anonymous">
  </a-assets>
  
  <a-sky id="sky" material="shader: flat"></a-sky>
  
  <a-entity id="cameraRig" position="0 1.6 0">
    <a-camera id="camera" wasd-controls-enabled="false">
      <a-cursor raycaster="objects: .clickable"></a-cursor>
      <a-text id="vrLoadingText" value="Loading Game..." align="center" position="0 0 -1.5" color="white" width="3" visible="false"></a-text>
    </a-camera>
    <a-entity id="rightController" 
              oculus-touch-controls="hand: right"
              laser-controls="hand: right"
              raycaster="objects: .clickable; far: 20;">
    </a-entity>
  </a-entity>
  
  <a-entity id="gameUI" position="0 1.5 -2.5" visible="false">
    <a-plane id="guessBtn" class="clickable" position="0 0.25 0" width="1.2" height="0.4" color="#9C27B0">
      <a-text value="MAKE GUESS" align="center" color="white" position="0 0 0.01" width="1.1"></a-text>
    </a-plane>
    <a-plane id="confirmBtn" class="clickable" position="0 -0.25 0" width="1.2" height="0.4" color="#FF9800" visible="false">
      <a-text value="CONFIRM GUESS" align="center" color="white" position="0 0 0.01" width="1.1"></a-text>
    </a-plane>
    <a-plane id="nextRoundBtn" class="clickable" position="0 0.25 0" width="1.2" height="0.4" color="#4CAF50" visible="false">
      <a-text value="NEXT ROUND" align="center" color="white" position="0 0 0.01" width="1.1"></a-text>
    </a-plane>
  </a-entity>
  
  <a-entity id="mapWrapper" position="-2.5 1.5 -2.5" rotation="0 35 0" visible="false">
    <a-plane id="mapPanel" class="clickable" width="2" height="1.25" material="shader: flat; side: double">
      <a-text id="locationText" value="Click MAKE GUESS to start" align="center" position="0 -0.7 0.01" color="black" width="1.8"></a-text>
    </a-plane>
  </a-entity>
  
  <a-entity id="scoreAndTimer" position="0 2.8 -2.5" visible="false">
    <a-text id="scoreText" value="SCORE: 0" align="center" color="white" width="3"></a-text>
    <a-text id="timerText" value="02:00" align="right" position="1.5 0 0" color="white" width="2"></a-text>
  </a-entity>
  
  <a-entity id="resultsPanel" position="0 1.5 -2" visible="false">
    <a-plane width="2.2" height="1.2" color="#333333" opacity="0.9">
      <a-text id="resultsText" value="" align="center" color="white" position="0 0 0.01" width="2"></a-text>
    </a-plane>
  </a-entity>
</a-scene>

<script>
class VRGeoGuessr {
  constructor() {
    this.startButton = document.getElementById('startButton');
    this.scene = document.getElementById('scene');
    this.assetsContainer = document.getElementById('assets-container');
    this.sky = document.getElementById('sky');
    this.vrLoadingText = document.getElementById('vrLoadingText');
    this.gameUI = document.getElementById('gameUI');
    this.guessBtn = document.getElementById('guessBtn');
    this.confirmBtn = document.getElementById('confirmBtn');
    this.nextRoundBtn = document.getElementById('nextRoundBtn');
    this.mapWrapper = document.getElementById('mapWrapper');
    this.mapPanel = document.getElementById('mapPanel');
    this.locationText = document.getElementById('locationText');
    this.scoreAndTimer = document.getElementById('scoreAndTimer');
    this.scoreText = document.getElementById('scoreText');
    this.timerText = document.getElementById('timerText');
    this.resultsPanel = document.getElementById('resultsPanel');
    this.resultsText = document.getElementById('resultsText');
    this.mapContainer = document.getElementById('mapContainer');

    this.data = [];
    this.leafletMap = null;
    this.score = 0;
    this.round = 0;
    this.totalRounds = 5;
    this.timer = null;
    this.timeLeft = 120;
    this.isInGuessMode = false;
    this.currentGuess = null;
    this.acceptingInput = false; // *** FIX: Start with input disabled ***

    this.bindEvents();
  }

  bindEvents() {
    this.startButton.addEventListener('click', () => this.initExperience());
    
    // *** FIX: Add guard clause to all click handlers ***
    this.guessBtn.addEventListener('click', () => { if (this.acceptingInput) this.startGuessing(); });
    this.confirmBtn.addEventListener('click', () => { if (this.acceptingInput) this.submitGuess(); });
    this.nextRoundBtn.addEventListener('click', () => { if (this.acceptingInput) this.startNewRound(); });
    
    this.mapPanel.addEventListener('click', (event) => {
        if (!this.acceptingInput || !this.isInGuessMode || !event.detail.intersection) return;
        this.handleControllerMapClick(event.detail.intersection.uv);
    });
  }

  initExperience() {
    this.startButton.style.display = 'none';
    this.scene.setAttribute('visible', 'true');
    this.vrLoadingText.setAttribute('visible', 'true');

    this.scene.enterVR().then(() => this.loadAndStartGame())
      .catch(err => {
        console.error("Could not enter VR mode:", err);
        this.loadAndStartGame();
    });
  }
  
  async loadAndStartGame() {
    try {
        await this.loadCSV();
        await this.preloadImages();
        this.initMap();
        
        this.vrLoadingText.setAttribute('visible', 'false');
        this.gameUI.setAttribute('visible', 'true');
        this.scoreAndTimer.setAttribute('visible', 'true');

        this.startNewRound();
    } catch(error) {
        console.error("Failed to load game assets:", error);
        this.vrLoadingText.setAttribute('value', `Error: ${error.message}`);
    }
  }

  updateTimer() {
    const minutes = Math.floor(this.timeLeft / 60);
    const seconds = this.timeLeft % 60;
    const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    this.timerText.setAttribute('value', timeStr);
  }

  startTimer() {
    this.updateTimer();
    this.timer = setInterval(() => {
      this.timeLeft--;
      this.updateTimer();
      if (this.timeLeft <= 0) {
        clearInterval(this.timer);
        this.endRound(false);
      }
    }, 1000);
  }

  resetTimer() {
    clearInterval(this.timer);
    this.timeLeft = 120;
  }

  async loadCSV() {
    return new Promise((resolve, reject) => {
      this.vrLoadingText.setAttribute('value', 'Loading location data...');
      Papa.parse('locations.csv', {
        download: true, header: true,
        complete: (r) => {
          this.data = r.data.filter(row => row.filename && row.latitude && row.longitude);
          if (this.data.length === 0) return reject(new Error('No valid locations in CSV'));
          resolve();
        },
        error: (err) => reject(new Error(`CSV Error: ${err.message}`))
      });
    });
  }

  preloadImages() {
    return new Promise((resolve) => {
      let loadedCount = 0;
      const totalImages = this.data.length;
      this.vrLoadingText.setAttribute('value', `Loading images (0/${totalImages})...`);
      
      this.data.forEach((row, i) => {
        const img = document.createElement('img');
        img.id = `img-${i}`;
        img.crossOrigin = 'anonymous';
        img.src = `Images/${row.filename.trim()}`;
        const onFinish = () => {
            loadedCount++;
            this.vrLoadingText.setAttribute('value', `Loading images (${loadedCount}/${totalImages})...`);
            if (loadedCount === totalImages) resolve();
        }
        img.onload = onFinish;
        img.onerror = () => { row.failedToLoad = true; onFinish(); };
        this.assetsContainer.appendChild(img);
      });
    });
  }

  initMap() {
    if (this.leafletMap) this.leafletMap.remove();
    this.leafletMap = L.map(this.mapContainer, { center: [0, 0], zoom: 1, zoomControl: false, attributionControl: false, preferCanvas: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, crossOrigin: true }).addTo(this.leafletMap);
    setTimeout(() => this.leafletMap.invalidateSize(), 500);
  }

  updateMapTexture() {
    html2canvas(this.mapContainer, { useCORS: true, logging: false }).then(canvas => {
      const texture = new THREE.CanvasTexture(canvas);
      texture.minFilter = THREE.LinearFilter;
      const mesh = this.mapPanel.getObject3D('mesh');
      if (mesh && mesh.material) {
        mesh.material.map = texture;
        mesh.material.needsUpdate = true;
      }
    }).catch(err => console.error('Map render error:', err));
  }

  startNewRound() {
    this.round++;
    this.acceptingInput = false; // *** FIX: Disable input at start of round ***
    
    this.isInGuessMode = false;
    this.currentGuess = null;
    this.resultsPanel.setAttribute('visible', 'false');
    this.mapWrapper.setAttribute('visible', 'false');
    this.confirmBtn.setAttribute('visible', 'false');
    this.nextRoundBtn.setAttribute('visible', 'false');
    this.guessBtn.setAttribute('visible', 'true');
    
    const randomIdx = Math.floor(Math.random() * this.data.length);
    this.currentIdx = randomIdx;
    const location = this.data[this.currentIdx];
    this.sky.setAttribute('src', location.failedToLoad ? '#fallback' : `#img-${this.currentIdx}`);
    
    this.resetTimer();
    this.startTimer();

    // *** FIX: Re-enable input after a 1-second grace period ***
    setTimeout(() => { this.acceptingInput = true; }, 1000);
  }

  startGuessing() {
    this.isInGuessMode = true;
    this.mapWrapper.setAttribute('visible', 'true');
    this.guessBtn.setAttribute('visible', 'false');
    this.confirmBtn.setAttribute('visible', 'true');
    this.locationText.setAttribute('value', 'Point and click on the map\nto place your guess');
    
    this.leafletMap.setView([20, 0], 2);
    this.leafletMap.eachLayer(layer => { if (layer instanceof L.Marker) this.leafletMap.removeLayer(layer); });
    this.updateMapTexture();
  }
  
  handleControllerMapClick(uv) {
    const bounds = this.leafletMap.getBounds();
    const lng = bounds.getWest() + (bounds.getEast() - bounds.getWest()) * uv.x;
    const lat = bounds.getSouth() + (bounds.getNorth() - bounds.getSouth()) * (1 - uv.y);
    const latlng = L.latLng(lat, lng);

    this.leafletMap.eachLayer(layer => { if (layer instanceof L.Marker) this.leafletMap.removeLayer(layer); });
    L.marker(latlng).addTo(this.leafletMap);
    this.currentGuess = latlng;
    this.locationText.setAttribute('value', 'Pin placed! Click CONFIRM GUESS');
    this.updateMapTexture();
  }

  submitGuess() {
    if (!this.currentGuess) { this.locationText.setAttribute('value', 'Please place a pin on the map first'); return; }
    this.endRound(true, this.currentGuess);
  }

  calculateScore(distance) {
    return Math.round(5000 * Math.exp(-0.000002 * distance));
  }

  endRound(guessed, guessLatLng) {
    this.acceptingInput = false; // Disable input when showing results
    clearInterval(this.timer);
    
    const location = this.data[this.currentIdx];
    const actualLoc = L.latLng(parseFloat(location.latitude), parseFloat(location.longitude));
    let roundScore = 0, distance = 0;
    
    if (guessed) {
      distance = this.leafletMap.distance(guessLatLng, actualLoc);
      roundScore = this.calculateScore(distance);
      this.score += roundScore;
      this.scoreText.setAttribute('value', `SCORE: ${this.score}`);
      L.marker(guessLatLng).addTo(this.leafletMap);
    }
    
    L.marker(actualLoc, { icon: L.divIcon({className: 'correct-pin', html: 'üìç', iconSize:[24,24], iconAnchor:[12,24]}) }).addTo(this.leafletMap);
    if (guessed) this.leafletMap.fitBounds(L.polyline([guessLatLng, actualLoc]).getBounds().pad(0.2));
    else this.leafletMap.setView(actualLoc, 5);
    this.updateMapTexture();
    
    this.resultsText.setAttribute('value', `ROUND ${this.round}/${this.totalRounds}\n` + (guessed ? `DISTANCE: ${(distance/1000).toFixed(1)} km\nPOINTS: ${roundScore}` : 'TIME EXPIRED!') + `\n\nTOTAL SCORE: ${this.score}`);
    
    this.resultsPanel.setAttribute('visible', 'true');
    this.guessBtn.setAttribute('visible', 'false');
    this.confirmBtn.setAttribute('visible', 'false');
    this.mapWrapper.setAttribute('visible', 'true');
    
    if (this.round < this.totalRounds) {
      this.nextRoundBtn.setAttribute('visible', 'true');
      setTimeout(() => { this.acceptingInput = true; }, 500); // Re-enable for next round button
    } else {
      this.nextRoundBtn.setAttribute('visible', 'false');
      setTimeout(() => { this.resultsText.setAttribute('value', `GAME OVER!\nFINAL SCORE: ${this.score}`); }, 4000);
    }
  }
}

document.addEventListener('DOMContentLoaded', () => { new VRGeoGuessr(); });
</script>
</body>
</html>
