<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VR GeoGuessr - Fixed Version</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: #000;
    }
    
    #startButton {
      position: absolute; 
      top: 50%; 
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px; 
      font-size: 18px;
      background: #2196F3; 
      color: #fff; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer;
      z-index: 999;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    #loading {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
    }
    
    #error {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
      max-width: 80%;
      text-align: center;
    }
    
    #mapContainer {
      position: fixed;
      top: -10000px;
      left: -10000px;
      width: 1024px;
      height: 640px;
      background: white;
    }
    
    #timer {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 24px;
      z-index: 1000;
      display: none;
    }
    
    .a-enter-vr-button {
      z-index: 1001 !important;
    }
    
    /* Custom laser pointer style */
    .laser-pointer {
      position: absolute;
      width: 2px;
      height: 100px;
      background-color: red;
      transform-origin: top center;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>

<button id="startButton">Start Game</button>
<div id="loading">Loading assets, please wait...</div>
<div id="error"></div>
<div id="timer">02:00</div>

<!-- Offscreen Leaflet map -->
<div id="mapContainer"></div>

<!-- Custom laser pointer -->
<div id="laserPointer" class="laser-pointer"></div>

<a-scene id="scene" 
         vr-mode-ui="enabled: true"
         loading-screen="dotsColor: #0080e5; backgroundColor: #000000"
         renderer="antialias: true; logarithmicDepthBuffer: true"
         visible="false">
         
  <a-assets>
    <!-- Fallback image -->
    <img id="fallback" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z/C/HgAGgwJ/lK3Q6wAAAABJRU5ErkJggg==" crossorigin="anonymous">
  </a-assets>
  
  <!-- 360¬∞ panorama background -->
  <a-sky id="sky" color="#000000"></a-sky>
  
  <!-- Camera rig with proper controller setup -->
  <a-entity id="cameraRig" position="0 1.6 0">
    <a-camera id="camera" wasd-controls="enabled: false">
      <a-cursor fuse="true" fuse-timeout="800"
                raycaster="objects: .clickable"
                material="color: cyan"
                geometry="radiusInner: 0.005; radiusOuter: 0.015">
      </a-cursor>
    </a-camera>
    
    <!-- Right controller with natural pointer position -->
    <a-entity id="rightController" 
              hand-controls="hand: right"
              oculus-touch-controls="hand: right"
              vive-controls="hand: right"
              raycaster="objects: .clickable; far: 20; interval: 0"
              laser-controls="hand: right; color: red">
      <!-- Custom pointer coming from finger position -->
      <a-entity position="0 -0.015 -0.05" rotation="-15 0 0">
        <a-entity line="start: 0 0 0; end: 0 0 -1; color: red; opacity: 0.5" visible="false"></a-entity>
      </a-entity>
    </a-entity>
  </a-entity>
  
  <!-- Game UI with proper text -->
  <a-entity id="gameUI" position="0 0 -2">
    <!-- Make Guess Button -->
    <a-plane id="guessBtn" class="clickable" position="0 1 0" width="1.2" height="0.4" color="#9C27B0">
      <a-text value="MAKE GUESS" align="center" color="white" position="0 0 0.01" width="1.1"></a-text>
    </a-plane>
    
    <!-- Confirm Button -->
    <a-plane id="confirmBtn" class="clickable" position="0 0.5 0" width="1.2" height="0.4" color="#FF9800" visible="false">
      <a-text value="CONFIRM GUESS" align="center" color="white" position="0 0 0.01" width="1.1"></a-text>
    </a-plane>
    
    <!-- Next Round Button -->
    <a-plane id="nextRoundBtn" class="clickable" position="0 0 0" width="1.2" height="0.4" color="#4CAF50" visible="false">
      <a-text value="NEXT ROUND" align="center" color="white" position="0 0 0.01" width="1.1"></a-text>
    </a-plane>
  </a-entity>
  
  <!-- Map Panel with visible pin -->
  <a-entity id="mapWrapper" position="-2 1.5 -1.5">
    <a-plane id="mapPanel" class="clickable" width="1.6" height="1" material="shader: flat; side: double">
      <a-text id="locationText" value="Click MAKE GUESS to start" align="center" position="0 -0.6 0.01" color="black" width="1.5"></a-text>
    </a-plane>
    <!-- 3D Pin Marker -->
    <a-entity id="mapPin" visible="false" position="0 0 0.02">
      <a-cone color="#FF0000" radius-bottom="0.05" height="0.2" position="0 0.1 0"></a-cone>
      <a-sphere color="#FF0000" radius="0.03" position="0 0.2 0"></a-sphere>
    </a-entity>
  </a-entity>
  
  <!-- Score Display -->
  <a-entity position="0 2 -2">
    <a-text id="scoreText" value="SCORE: 0" align="center" color="white" width="3"></a-text>
  </a-entity>
  
  <!-- Results Display -->
  <a-entity id="resultsPanel" position="0 1.3 -1.5" visible="false">
    <a-plane width="2" height="1" color="#333">
      <a-text id="resultsText" value="" align="center" color="white" position="0 0 0.01" width="1.8"></a-text>
    </a-plane>
  </a-entity>
  
  <!-- Fallback for non-VR -->
  <a-entity id="nonVrMessage" position="0 1.6 -3" visible="false">
    <a-text value="VR not available\nUse mouse to look around" 
           align="center" color="white" width="3"></a-text>
  </a-entity>
</a-scene>

<script>
// Game Manager Class
class VRGeoGuessr {
  constructor() {
    // DOM elements
    this.startButton = document.getElementById('startButton');
    this.loadingIndicator = document.getElementById('loading');
    this.errorDisplay = document.getElementById('error');
    this.scene = document.getElementById('scene');
    this.sky = document.getElementById('sky');
    this.guessBtn = document.getElementById('guessBtn');
    this.confirmBtn = document.getElementById('confirmBtn');
    this.nextRoundBtn = document.getElementById('nextRoundBtn');
    this.mapPanel = document.getElementById('mapPanel');
    this.mapPin = document.getElementById('mapPin');
    this.locationText = document.getElementById('locationText');
    this.scoreText = document.getElementById('scoreText');
    this.resultsPanel = document.getElementById('resultsPanel');
    this.resultsText = document.getElementById('resultsText');
    this.nonVrMessage = document.getElementById('nonVrMessage');
    this.mapContainer = document.getElementById('mapContainer');
    this.timerDisplay = document.getElementById('timer');
    this.rightController = document.getElementById('rightController');
    this.laserPointer = document.getElementById('laserPointer');

    // Game state
    this.data = [];
    this.currentIdx = 0;
    this.leafletMap = null;
    this.score = 0;
    this.round = 1;
    this.totalRounds = 5;
    this.timer = null;
    this.timeLeft = 120;
    this.isInGuessMode = false;
    this.currentGuess = null;
    this.isVRAvailable = false;

    // Initialize
    this.bindEvents();
  }

  bindEvents() {
    this.startButton.addEventListener('click', () => this.initExperience());
    
    // Controller events
    this.rightController.addEventListener('triggerdown', () => this.handleControllerTrigger());
    
    // UI events
    this.guessBtn.addEventListener('click', () => this.startGuessing());
    this.confirmBtn.addEventListener('click', () => this.submitGuess());
    this.nextRoundBtn.addEventListener('click', () => this.startNewRound());
  }

  async initExperience() {
    try {
      this.showLoading("Initializing VR experience...");
      this.startButton.style.display = 'none';
      this.scene.setAttribute('visible', 'true');
      
      // Check VR support
      this.isVRAvailable = await this.checkVRSupport();
      
      // Load game data
      await this.loadCSV();
      await this.preloadImages();
      this.initMap();
      
      // Start first round
      this.setRandomImage();
      
    } catch (error) {
      this.showError(`Initialization failed: ${error.message}`);
      this.startButton.style.display = 'block';
    } finally {
      this.hideLoading();
    }
  }

  async checkVRSupport() {
    if (!navigator.xr) {
      this.nonVrMessage.setAttribute('visible', 'true');
      return false;
    }
    
    try {
      const supported = await navigator.xr.isSessionSupported('immersive-vr');
      if (!supported) {
        this.nonVrMessage.setAttribute('visible', 'true');
      }
      return supported;
    } catch (err) {
      console.error("VR support check failed:", err);
      this.nonVrMessage.setAttribute('visible', 'true');
      return false;
    }
  }

  showLoading(message) {
    this.loadingIndicator.textContent = message;
    this.loadingIndicator.style.display = 'block';
  }

  hideLoading() {
    this.loadingIndicator.style.display = 'none';
  }

  showError(message) {
    this.errorDisplay.textContent = message;
    this.errorDisplay.style.display = 'block';
    setTimeout(() => {
      this.errorDisplay.style.display = 'none';
    }, 5000);
  }

  updateTimer() {
    const minutes = Math.floor(this.timeLeft / 60);
    const seconds = this.timeLeft % 60;
    this.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }

  startTimer() {
    this.timerDisplay.style.display = 'block';
    this.updateTimer();
    this.timer = setInterval(() => {
      this.timeLeft--;
      this.updateTimer();
      
      if (this.timeLeft <= 0) {
        clearInterval(this.timer);
        this.endRound(false);
      }
    }, 1000);
  }

  resetTimer() {
    clearInterval(this.timer);
    this.timeLeft = 120;
    this.updateTimer();
  }

  async loadCSV() {
    return new Promise((resolve, reject) => {
      this.showLoading("Loading location data...");
      
      Papa.parse('locations.csv', {
        download: true,
        header: true,
        complete: (r) => {
          this.data = r.data.filter(row => row.filename && row.latitude && row.longitude);
          
          if (this.data.length === 0) {
            reject(new Error('No valid data found in CSV'));
            return;
          }
          
          resolve(this.data);
        },
        error: (err) => {
          reject(new Error(`Failed to load CSV: ${err.message}`));
        }
      });
    });
  }

  preloadImages() {
    return new Promise((resolve) => {
      this.showLoading("Preloading panoramic images...");
      let loadedCount = 0;
      const totalImages = this.data.length;
      
      this.data.forEach((row, i) => {
        const img = new Image();
        img.id = `img-${i}`;
        img.crossOrigin = 'anonymous';
        img.src = `Images/${row.filename.trim()}`;
        
        img.onload = () => {
          loadedCount++;
          if (loadedCount === totalImages) {
            resolve();
          }
        };
        
        img.onerror = () => {
          console.error(`Failed to load image: ${row.filename}`);
          row.failedToLoad = true;
          loadedCount++;
          
          if (loadedCount === totalImages) {
            resolve();
          }
        };
      });
    });
  }

  initMap() {
    if (this.leafletMap) {
      this.leafletMap.remove();
    }

    this.leafletMap = L.map(this.mapContainer, {
      center: [0, 0],
      zoom: 1,
      zoomControl: false,
      attributionControl: false,
      preferCanvas: true
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      crossOrigin: true
    }).addTo(this.leafletMap);

    setTimeout(() => {
      this.leafletMap.invalidateSize();
      this.updateMapTexture();
    }, 500);
  }

  updateMapTexture() {
    html2canvas(this.mapContainer, {
      backgroundColor: null,
      scale: 1,
      useCORS: true,
      allowTaint: true,
      logging: false
    }).then(canvas => {
      const texture = new THREE.CanvasTexture(canvas);
      texture.anisotropy = 16;
      texture.minFilter = THREE.LinearFilter;
      
      const mesh = this.mapPanel.getObject3D('mesh');
      if (mesh) {
        mesh.material.map = texture;
        mesh.material.needsUpdate = true;
      }
    }).catch(err => {
      console.error('Map render error:', err);
      setTimeout(() => this.updateMapTexture(), 500);
    });
  }

  setRandomImage() {
    const randomIdx = Math.floor(Math.random() * this.data.length);
    this.currentIdx = randomIdx;
    const location = this.data[this.currentIdx];
    
    // Set 360¬∞ panorama background
    const imgId = location.failedToLoad ? '#fallback' : `#img-${this.currentIdx}`;
    this.sky.setAttribute('src', imgId);
    this.sky.setAttribute('color', '#fff');
    
    // Reset map for guessing
    this.leafletMap.setView([0, 0], 1);
    this.leafletMap.eachLayer(layer => {
      if (layer instanceof L.Marker) {
        this.leafletMap.removeLayer(layer);
      }
    });
    this.updateMapTexture();
    
    // Update UI
    this.guessBtn.setAttribute('visible', 'true');
    this.confirmBtn.setAttribute('visible', 'false');
    this.nextRoundBtn.setAttribute('visible', 'false');
    this.resultsPanel.setAttribute('visible', 'false');
    this.mapPin.setAttribute('visible', 'false');
    this.locationText.setAttribute('value', 'Explore the location\nThen click MAKE GUESS');
    this.isInGuessMode = false;
    this.currentGuess = null;
    
    // Start timer
    this.resetTimer();
    this.startTimer();
  }

  startGuessing() {
    this.isInGuessMode = true;
    this.guessBtn.setAttribute('visible', 'false');
    this.confirmBtn.setAttribute('visible', 'true');
    this.locationText.setAttribute('value', 'Click on the map\nto place your pin');
    
    // Set up map click handler
    this.leafletMap.on('click', (e) => {
      this.handleMapClick(e);
    });
  }

  handleMapClick(e) {
    // Clear previous markers
    this.leafletMap.eachLayer(layer => {
      if (layer instanceof L.Marker) {
        this.leafletMap.removeLayer(layer);
      }
    });
    
    // Add new marker to Leaflet map
    L.marker(e.latlng, {
      icon: L.divIcon({
        className: 'map-pin',
        html: '<div style="color:red;font-size:24px">üìç</div>',
        iconSize: [24, 24],
        iconAnchor: [12, 24]
      })
    }).addTo(this.leafletMap);
    
    // Update 3D pin position
    const bounds = this.leafletMap.getBounds();
    const mapSize = this.mapPanel.getAttribute('width');
    const x = ((e.latlng.lng - bounds.getWest()) / (bounds.getEast() - bounds.getWest()) - 0.5) * mapSize;
    const y = -((e.latlng.lat - bounds.getSouth()) / (bounds.getNorth() - bounds.getSouth()) - 0.5) * (mapSize * 0.625);
    
    this.mapPin.setAttribute('position', `${x} ${y} 0.02`);
    this.mapPin.setAttribute('visible', 'true');
    this.currentGuess = e.latlng;
    this.locationText.setAttribute('value', 'Pin placed!\nClick CONFIRM GUESS');
    this.updateMapTexture();
  }

  handleControllerTrigger() {
    if (!this.isInGuessMode || !this.leafletMap) return;
    
    // Get intersection with map panel
    const intersection = this.rightController.components.raycaster.getIntersection(this.mapPanel);
    if (intersection) {
      // Convert intersection to map coordinates
      const point = intersection.point;
      const mapSize = this.mapPanel.getAttribute('width');
      const halfSize = mapSize / 2;
      
      const x = (point.x / halfSize);
      const y = -(point.y / halfSize);
      
      const bounds = this.leafletMap.getBounds();
      const lat = bounds.getSouth() + (1 - y) * (bounds.getNorth() - bounds.getSouth());
      const lng = bounds.getWest() + (x + 1) * (bounds.getEast() - bounds.getWest()) / 2;
      
      // Trigger map click
      this.leafletMap.fire('click', {
        latlng: L.latLng(lat, lng),
        layerPoint: this.leafletMap.latLngToLayerPoint(L.latLng(lat, lng))
      });
    }
  }

  submitGuess() {
    if (!this.currentGuess) {
      this.locationText.setAttribute('value', 'Please place a pin\non the map first');
      return;
    }
    
    this.leafletMap.off('click'); // Remove map click listener
    this.endRound(true, this.currentGuess);
  }

  calculateScore(distance) {
    const maxPoints = 5000;
    const maxDistance = 20000;
    const points = Math.max(0, maxPoints * (1 - distance / maxDistance));
    return Math.round(points);
  }

  endRound(guessed, guessLatLng) {
    clearInterval(this.timer);
    this.isInGuessMode = false;
    
    const location = this.data[this.currentIdx];
    const actualLoc = [parseFloat(location.latitude), parseFloat(location.longitude)];
    
    // Show correct location
    this.leafletMap.setView(actualLoc, 12);
    L.marker(actualLoc, {
      icon: L.divIcon({
        className: 'correct-pin',
        html: '<div style="color:green;font-size:24px">üìç</div>',
        iconSize: [24, 24],
        iconAnchor: [12, 24]
      })
    }).addTo(this.leafletMap);
    this.updateMapTexture();
    
    // Update score if guessed
    let roundScore = 0;
    let distance = 0;
    
    if (guessed) {
      distance = this.leafletMap.distance(guessLatLng, actualLoc);
      roundScore = this.calculateScore(distance);
      this.score += roundScore;
      this.scoreText.setAttribute('value', `SCORE: ${this.score}`);
    }
    
    // Show results
    this.resultsText.setAttribute('value', 
      `ROUND ${this.round}/${this.totalRounds}\n` +
      (guessed ? `DISTANCE: ${(distance/1000).toFixed(1)} km\nPOINTS: ${roundScore}` : 'TIME EXPIRED!') +
      `\nTOTAL: ${this.score}`);
    
    this.resultsPanel.setAttribute('visible', 'true');
    this.guessBtn.setAttribute('visible', 'false');
    this.confirmBtn.setAttribute('visible', 'false');
    
    // Show next round button or end game
    if (this.round < this.totalRounds) {
      this.nextRoundBtn.setAttribute('visible', 'true');
    } else {
      setTimeout(() => {
        this.resultsText.setAttribute('value', 
          `GAME OVER!\nFINAL SCORE: ${this.score}\n` +
          `AVERAGE: ${Math.round(this.score/this.totalRounds)} per round`);
      }, 2000);
    }
  }

  startNewRound() {
    this.round++;
    this.setRandomImage();
  }
}

// Initialize the game when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  // Start the game
  const game = new VRGeoGuessr();
  
  // Fallback data for local testing
  if (window.location.href.includes('localhost') || window.location.href.includes('127.0.0.1')) {
    window.fallbackData = [
      {filename: 'pano1.jpg', latitude: '40.7128', longitude: '-74.0060', name: 'New York'},
      {filename: 'pano2.jpg', latitude: '51.5074', longitude: '-0.1278', name: 'London'},
      {filename: 'pano3.jpg', latitude: '48.8566', longitude: '2.3522', name: 'Paris'},
      {filename: 'pano4.jpg', latitude: '35.6762', longitude: '139.6503', name: 'Tokyo'},
      {filename: 'pano5.jpg', latitude: '-33.8688', longitude: '151.2093', name: 'Sydney'}
    ];
    
    setTimeout(() => {
      if (game.data.length === 0 && window.fallbackData) {
        game.data = window.fallbackData;
        game.preloadImages();
        game.initMap();
      }
    }, 3000);
  }
});
</script>
</body>
</html>
