<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>360° Image Viewer with VR UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html, body {
      margin: 0; height: 100%; overflow: hidden; background: #111; font-family: sans-serif;
    }
    #startButton {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      padding: 20px 40px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      z-index: 9999;
      user-select: none;
    }
  </style>
</head>
<body>

<button id="startButton">▶ Start VR</button>

<a-scene embedded vr-mode-ui="enabled: false" visible="false" id="vrScene" background="color: black" raycaster="objects: .clickable">
  <a-assets id="assetsContainer"></a-assets>

  <a-sky id="sky" color="#000000" rotation="0 -130 0"></a-sky>

  <a-entity id="cameraRig" position="0 1.6 0">
    <a-entity camera look-controls wasd-controls>
      <a-cursor
        id="cursor"
        fuse="true"
        fuse-timeout="1500"
        raycaster="objects: .clickable"
        material="color: cyan; shader: flat"
        geometry="radiusInner: 0.005; radiusOuter: 0.015"
        position="0 0 -1"
      ></a-cursor>
    </a-entity>
  </a-entity>

  <a-plane id="nextBtn" class="clickable" position="0 1 -2" width="0.8" height="0.3" material="color: #4CAF50"
           event-set__enter="_event: mouseenter; material.color: #66BB6A"
           event-set__leave="_event: mouseleave; material.color: #4CAF50"
           visible="true">
    <a-text value="Next Image ▶" align="center" color="white" position="0 0 0.01" width="4"></a-text>
  </a-plane>
</a-scene>

<script>
  const startButton = document.getElementById('startButton');
  const vrScene = document.getElementById('vrScene');
  const sky = document.getElementById('sky');
  const assetsContainer = document.getElementById('assetsContainer');
  const nextBtn = document.getElementById('nextBtn');

  let images = [];
  let currentIndex = 0;

  function log(...args) {
    console.log('[360 Viewer]', ...args);
  }

  // Load CSV and preload images
  function loadImagesCSV() {
    return new Promise((resolve, reject) => {
      log('Loading CSV...');
      Papa.parse('locations.csv', {
        download: true,
        header: true,
        complete: (results) => {
          log('CSV loaded', results.data);
          images = results.data
            .map(row => row.filename)       // Only pick the filename field
            .filter(name => name && name.trim() !== '');
          if (images.length === 0) {
            reject('No images found in CSV.');
            return;
          }
          preloadImages(images).then(resolve).catch(reject);
        },
        error: (err) => reject(err)
      });
    });
  }

  // Preload images as assets in A-Frame
  function preloadImages(filenames) {
    return new Promise((resolve) => {
      let loadedCount = 0;
      filenames.forEach(name => {
        const imgId = name.replace(/\.[^/.]+$/, '').toLowerCase();
        if (!document.getElementById(imgId)) {
          const imgEl = document.createElement('img');
          imgEl.setAttribute('id', imgId);
          imgEl.setAttribute('src', `Images/${name}`);

          imgEl.addEventListener('load', () => {
            loadedCount++;
            log(`Image loaded: ${name} (${loadedCount}/${filenames.length})`);
            if (loadedCount === filenames.length) resolve();
          });
          imgEl.addEventListener('error', () => {
            log(`Error loading image: ${name}`);
            loadedCount++;
            if (loadedCount === filenames.length) resolve();
          });

          assetsContainer.appendChild(imgEl);
        } else {
          loadedCount++;
          if (loadedCount === filenames.length) resolve();
        }
      });

      if (filenames.length === 0) resolve();
    });
  }

  // Load current image to sky
  function loadCurrentImage() {
    const filename = images[currentIndex];
    const imgId = filename.replace(/\.[^/.]+$/, '').toLowerCase();
    log('Setting sky to:', imgId, `#${imgId}`, `Images/${filename}`);
    sky.setAttribute('src', `#${imgId}`);

    // Fallback if needed
    setTimeout(() => {
      const skySrc = sky.getAttribute('src');
      log('Current sky src:', skySrc);
      if (skySrc !== `#${imgId}`) {
        log('Sky src not properly set, applying fallback direct src');
        sky.setAttribute('src', `Images/${filename}`);
      }
    }, 2000);
  }

  // Next image button handler
  function onNextImage() {
    currentIndex = (currentIndex + 1) % images.length;
    loadCurrentImage();
  }

  function setupVRUI() {
    nextBtn.addEventListener('click', onNextImage);
  }

  startButton.addEventListener('click', () => {
    startButton.style.display = 'none';
    vrScene.setAttribute('visible', true);

    loadImagesCSV()
      .then(() => {
        loadCurrentImage();
        setupVRUI();
      })
      .catch(err => {
        alert('Error loading images: ' + err);
      });

    // Enter immersive VR if possible
    if (navigator.xr && navigator.xr.isSessionSupported) {
      navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
        if (supported) {
          navigator.xr.requestSession('immersive-vr').then(session => {
            vrScene.renderer.xr.setSession(session);
          }).catch(err => {
            console.warn('Failed to enter immersive VR:', err);
            vrScene.enterVR();
          });
        } else {
          vrScene.enterVR();
        }
      });
    } else {
      vrScene.enterVR();
    }
  });
</script>

</body>
</html>
