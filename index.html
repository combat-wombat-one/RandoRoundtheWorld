<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VR with Interactive Map Plane</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #startButton {
      position: absolute; top:50%; left:50%;
      transform: translate(-50%, -50%);
      padding:20px 40px; font-size:18px;
      background:#2196F3; color:#fff; border:none; border-radius:5px; cursor:pointer;
      z-index:999;
    }
    /* Hidden map container offscreen but with fixed size */
    #mapContainer {
      position: fixed;
      top: -10000px;
      left: -10000px;
      width: 512px;
      height: 320px;
    }
  </style>
</head>
<body>

<button id="startButton">Start VR</button>

<!-- Offscreen Leaflet map -->
<div id="mapContainer"></div>

<a-scene id="scene" embedded vr-mode-ui="enabled:false" visible="false">
  <a-assets id="assets"></a-assets>
  <a-sky id="sky" color="#000000"></a-sky>
  <a-entity position="0 1.6 0">
    <a-camera>
      <a-cursor fuse="true" fuse-timeout="800"
                raycaster="objects:.clickable"
                material="color: cyan"
                geometry="radiusInner:0.005;radiusOuter:0.015">
      </a-cursor>
    </a-camera>
  </a-entity>
  <a-plane id="nextBtn" class="clickable" position="0 1 -2" width="1.2" height="0.4" color="#4CAF50">
    <a-text value="Next Image" align="center" color="white" position="0 0 0.01"></a-text>
  </a-plane>
  <a-plane id="mapPanel" position="-4 1 -2" width="1.6" height="1" color="#fff" material="shader: flat;"></a-plane>
</a-scene>

<script>
const startButton = document.getElementById('startButton');
const scene = document.getElementById('scene');
const assets = document.getElementById('assets');
const sky = document.getElementById('sky');
const nextBtn = document.getElementById('nextBtn');
const mapPanel = document.getElementById('mapPanel');
const mapContainer = document.getElementById('mapContainer');

let data = [], idx = 0;
let leafletMap;

function loadCSV() {
  Papa.parse('locations.csv', {
    download: true,
    header: true,
    complete(r) {
      data = r.data.filter(row => row.filename && row.latitude && row.longitude);
      preloadImages();
      initMap();
    }
  });
}

function preloadImages() {
  data.forEach((row, i) => {
    const img = document.createElement('img');
    img.id = 'img' + i;
    img.src = 'Images/' + row.filename.trim();
    img.onload = () => {
      if (i === 0) setSky(0);
    };
    img.onerror = () => console.error('Image load fail:', row.filename);
    assets.appendChild(img);
  });
}

function setSky(n) {
  idx = n % data.length;
  sky.setAttribute('src', '#img' + idx);
  sky.setAttribute('color', '#fff');

  if (leafletMap && data[idx]) {
    const lat = parseFloat(data[idx].latitude);
    const lon = parseFloat(data[idx].longitude);
    if (!isNaN(lat) && !isNaN(lon)) {
      leafletMap.setView([lat, lon], leafletMap.getZoom() || 5);
      updateMapTexture();
    }
  }
}

nextBtn.addEventListener('click', () => setSky(idx + 1));

function initMap() {
  leafletMap = L.map(mapContainer, {
    center: [0, 0],
    zoom: 2,
    zoomControl: true,
    attributionControl: false,
    dragging: true,
    scrollWheelZoom: true,
    doubleClickZoom: true,
    boxZoom: true,
    keyboard: true,
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18
  }).addTo(leafletMap);

  // Update texture on map move or zoom
  leafletMap.on('moveend zoomend', () => {
    updateMapTexture();
  });

  // Initial snapshot
  updateMapTexture();
}

function updateMapTexture() {
  html2canvas(mapContainer, {backgroundColor: null}).then(canvas => {
    const texture = new THREE.CanvasTexture(canvas);
    texture.minFilter = THREE.LinearFilter;
    texture.magFilter = THREE.LinearFilter;
    texture.needsUpdate = true;

    const mesh = mapPanel.getObject3D('mesh');
    if (mesh) {
      mesh.material.map = texture;
      mesh.material.needsUpdate = true;
    }
  });
}

startButton.addEventListener('click', () => {
  startButton.style.display = 'none';
  scene.setAttribute('visible', 'true');
  loadCSV();
  scene.enterVR();
});
</script>
</body>
</html>
