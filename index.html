<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>360¬∞ GeoGuess Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }

    button {
      position: absolute;
      top: 20px;
      padding: 10px 20px;
      background: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
      z-index: 1001;
    }

    #nextBtn { left: 20px; }
    #removeBtn { left: 160px; }
    #submitBtn { left: 300px; }

    #mapContainer {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 400px;
      height: 300px;
      border: 2px solid #ccc;
      z-index: 1000;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    #infoPanel {
      position: absolute;
      right: 20px;
      top: 20px;
      background: rgba(255,255,255,0.95);
      border-radius: 10px;
      padding: 15px 20px;
      font-family: sans-serif;
      font-size: 16px;
      z-index: 1001;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: none;
    }
  </style>
</head>
<body>
  <button id="nextBtn">üé≤ Next Location</button>
  <button id="removeBtn">üóë Remove Pin</button>
  <button id="submitBtn">‚úÖ Submit Guess</button>

  <div id="mapContainer"><div id="map"></div></div>
  <div id="infoPanel"></div>

  <a-scene vr-mode-ui="enabled: true">
    <a-assets id="assetsContainer"></a-assets>
    <a-sky id="sky" rotation="0 -130 0"></a-sky>
    <a-entity camera look-controls="magicWindowTrackingEnabled: true" position="0 1.6 0"></a-entity>
  </a-scene>

  <script>
    let locations = [];
    let current = 0;
    let marker = null;
    let trueMarker = null;
    let line = null;
    let map;

    function loadSky(filename) {
      const sky = document.getElementById("sky");
      sky.setAttribute("src", `Images/${filename}`);
    }

    function loadNextScene() {
      current = (current + 1) % locations.length;
      loadSky(locations[current].filename);
      clearMapObjects();
      document.getElementById("infoPanel").style.display = "none";
    }

    function clearMapObjects() {
      if (marker) { map.removeLayer(marker); marker = null; }
      if (trueMarker) { map.removeLayer(trueMarker); trueMarker = null; }
      if (line) { map.removeLayer(line); line = null; }
    }

    function distanceInKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function setupMap() {
      map = L.map('map').setView([20, 0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      map.on('click', function(e) {
        if (marker) map.removeLayer(marker);
        marker = L.marker(e.latlng).addTo(map);
      });
    }

    function setupButtons() {
      document.getElementById("nextBtn").addEventListener("click", loadNextScene);

      document.getElementById("removeBtn").addEventListener("click", () => {
        if (marker) { map.removeLayer(marker); marker = null; }
      });

      document.getElementById("submitBtn").addEventListener("click", () => {
        if (!marker) {
          alert("‚ùó Please drop a pin first.");
          return;
        }

        const guess = marker.getLatLng();
        const actual = locations[current];
        const dist = distanceInKm(guess.lat, guess.lng, actual.latitude, actual.longitude);
        const score = Math.max(0, Math.round(5000 - dist * 100));

        // Add true marker
        if (trueMarker) map.removeLayer(trueMarker);
        trueMarker = L.marker([actual.latitude, actual.longitude], {
          icon: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
          })
        }).addTo(map);

        // Draw line
        if (line) map.removeLayer(line);
        line = L.polyline([
          [guess.lat, guess.lng],
          [actual.latitude, actual.longitude]
        ], {
          color: 'red',
          weight: 3
        }).addTo(map);

        // Show info
        const panel = document.getElementById("infoPanel");
        panel.innerHTML = `
          <strong>üì∏ Image:</strong> ${actual.filename}<br>
          <strong>üìç Distance:</strong> ${dist.toFixed(2)} km<br>
          <strong>üéØ Score:</strong> ${score} / 5000
        `;
        panel.style.display = 'block';
      });
    }

    function preloadImages() {
      const assets = document.getElementById("assetsContainer");
      locations.forEach(loc => {
        const img = document.createElement("img");
        img.setAttribute("id", `img-${loc.filename}`);
        img.setAttribute("src", `Images/${loc.filename}`);
        img.setAttribute("crossorigin", "anonymous");
        img.style.display = "none";
        assets.appendChild(img);
      });
    }

    function init() {
      Papa.parse("locations.csv", {
        download: true,
        header: true,
        complete: (results) => {
          locations = results.data.map(row => ({
            filename: row.filename,
            latitude: parseFloat(row.latitude),
            longitude: parseFloat(row.longitude)
          })).filter(loc => !isNaN(loc.latitude) && !isNaN(loc.longitude));
          if (locations.length === 0) {
            alert("‚ö†Ô∏è No valid data in CSV.");
            return;
          }
          preloadImages();
          loadSky(locations[current].filename);
        }
      });

      // Permission request for iOS/Android motion sensors
      if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission().catch(() => {
          alert("üì± Motion access denied. Enable motion tracking for gyroscope support.");
        });
      }
    }

    setupMap();
    setupButtons();
    window.addEventListener("load", init);
  </script>
</body>
</html>
