<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>360¬∞ Location Guessing Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }

    button {
      position: absolute;
      top: 20px;
      padding: 10px 20px;
      background: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
      z-index: 1001;
    }

    #nextBtn { left: 20px; }
    #removeBtn { left: 160px; }
    #submitBtn { left: 300px; }

    #mapContainer {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 400px;
      height: 300px;
      border: 2px solid #ccc;
      z-index: 1000;
    }

    #map {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <button id="nextBtn">üé≤ Next Location</button>
  <button id="removeBtn">üóë Remove Pin</button>
  <button id="submitBtn">‚úÖ Submit Guess</button>

  <div id="mapContainer"><div id="map"></div></div>

  <a-scene>
    <a-assets id="assetsContainer"></a-assets>
    <a-sky id="sky" rotation="0 -130 0"></a-sky>
  </a-scene>

  <script>
    let locations = [];      // Loaded from CSV
    let current = 0;         // Current index
    let marker = null;       // Map marker
    let map;

    function loadSky(filename) {
      const sky = document.getElementById("sky");
      sky.setAttribute("src", `Images/${filename}`);
    }

    function loadNextScene() {
      current = (current + 1) % locations.length;
      loadSky(locations[current].filename);
    }

    function distanceInKm(lat1, lon1, lat2, lon2) {
      // Haversine Formula
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function setupMap() {
      map = L.map('map').setView([20, 0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      map.on('click', function(e) {
        if (marker) map.removeLayer(marker);
        marker = L.marker(e.latlng).addTo(map);
      });
    }

    function setupButtons() {
      document.getElementById("nextBtn").addEventListener("click", () => {
        if (marker) {
          map.removeLayer(marker);
          marker = null;
        }
        loadNextScene();
      });

      document.getElementById("removeBtn").addEventListener("click", () => {
        if (marker) {
          map.removeLayer(marker);
          marker = null;
        }
      });

      document.getElementById("submitBtn").addEventListener("click", () => {
        if (!marker) {
          alert("‚ùó Place a pin on the map first.");
          return;
        }
        const guess = marker.getLatLng();
        const actual = locations[current];
        const dist = distanceInKm(guess.lat, guess.lng, actual.latitude, actual.longitude);
        const score = Math.max(0, Math.round(5000 - dist * 100)); // out of 5000
        alert(`üìç You were ${dist.toFixed(2)} km away\nüéØ Score: ${score} / 5000`);
      });
    }

    function preloadImages() {
      const assets = document.getElementById("assetsContainer");
      locations.forEach(loc => {
        const img = document.createElement("img");
        img.setAttribute("id", `img-${loc.filename}`);
        img.setAttribute("src", `Images/${loc.filename}`);
        img.setAttribute("crossorigin", "anonymous");
        img.style.display = "none";
        assets.appendChild(img);
      });
    }

    function init() {
      Papa.parse("locations.csv", {
        download: true,
        header: true,
        complete: (results) => {
          locations = results.data.map(row => ({
            filename: row.filename,
            latitude: parseFloat(row.latitude),
            longitude: parseFloat(row.longitude)
          })).filter(loc => !isNaN(loc.latitude) && !isNaN(loc.longitude));
          if (locations.length === 0) {
            alert("‚ö†Ô∏è No valid data in CSV.");
            return;
          }
          preloadImages();
          loadSky(locations[current].filename);
        }
      });
    }

    setupMap();
    setupButtons();
    window.addEventListener("load", init);
  </script>
</body>
</html>
