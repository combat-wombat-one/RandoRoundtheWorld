<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Map Iframe</title>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; background: white; }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    const map = L.map('map', { center: [0, 0], zoom: 1, zoomControl: false, attributionControl: false });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);

    let roundElements = [];

    // Listen for commands from the main game window
    window.addEventListener('message', (event) => {
        const { command, data } = event.data;

        switch (command) {
            case 'cleanup':
                roundElements.forEach(el => map.removeLayer(el));
                roundElements = [];
                break;
            
            case 'setView':
                map.setView(data.center, data.zoom);
                break;

            case 'placeGuessPin':
                const guessLatLng = L.latLng(data.latlng.lat, data.latlng.lng);
                if (roundElements.length > 0 && roundElements[0] instanceof L.Marker) {
                    roundElements[0].setLatLng(guessLatLng);
                } else {
                    const guessMarker = L.marker(guessLatLng).addTo(map);
                    roundElements.unshift(guessMarker);
                }
                break;

            case 'showResults':
                const { guessLatLng, actualLoc } = data;
                const guessPoint = L.latLng(guessLatLng.lat, guessLatLng.lng);
                const actualPoint = L.latLng(actualLoc[0], actualLoc[1]);

                const correctPin = L.marker(actualPoint, { icon: L.divIcon({className: 'correct-pin', html: 'üìç', iconSize:[24,24], iconAnchor:[12,24]}) }).addTo(map);
                const line = L.polyline([guessPoint, actualPoint], {color: 'blue'}).addTo(map);
                
                roundElements.push(correctPin);
                roundElements.push(line);
                
                map.fitBounds(line.getBounds().pad(0.2));

                // *** FIX: Calculate distance and send it back to the main game ***
                const distance = map.distance(guessPoint, actualPoint);
                parent.postMessage({ command: 'distanceCalculated', data: { distance: distance } }, '*');
                break;
        }
    });
</script>
</body>
</html>
